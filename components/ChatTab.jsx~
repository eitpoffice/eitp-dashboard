"use client";
import { useState, useMemo, useEffect, useRef } from 'react';
import { useAdmin } from '@/context/AdminContext';
import { User, Users, MessageCircle, Send, Paperclip, CheckCircle, Trash2, X, Search } from 'lucide-react';

export default function ChatTab({ mode }) { // mode = 'admin' or 'intern'
  const { currentIntern, interns, messages, sendUnifiedMessage, deleteUnifiedMessage } = useAdmin();
  
  const [activeContact, setActiveContact] = useState(null);
  const [msgText, setMsgText] = useState('');
  const [msgFile, setMsgFile] = useState(null);
  const [search, setSearch] = useState('');
  const chatEndRef = useRef(null);

  // BULLETPROOF RED DOT STATE (Tracks total messages read)
  const [readCounts, setReadCounts] = useState({});

  useEffect(() => {
    setReadCounts(JSON.parse(localStorage.getItem('eitp_chat_counts')) || {});
  }, []);

  // 1. Build Contact List
  const contactsList = useMemo(() => {
    let list = mode === 'admin' ? interns : [
      { id: 'all_admins', name: 'Admin Team', isGroup: true, branch: 'Official Support' },
      ...interns.filter(i => String(i.id) !== String(currentIntern?.id))
    ];
    return list.filter(c => c.name.toLowerCase().includes(search.toLowerCase()));
  }, [interns, currentIntern, search, mode]);

  // 2. Filter Active Chat
  const activeChats = useMemo(() => {
    if (!activeContact) return [];
    return messages.filter(m => {
      const isMeSender = String(m.sender_id) === String(currentIntern?.id);
      const isMeRecipient = String(m.recipient_id) === String(currentIntern?.id);

      if (activeContact.id === 'all_admins') {
        return (isMeSender && m.recipient_id === 'all_admins') || (isMeRecipient && m.type === 'direct_admin');
      }
      const isTargetRecipient = String(m.recipient_id) === String(activeContact.id);
      const isTargetSender = String(m.sender_id) === String(activeContact.id);
      return (isMeSender && isTargetRecipient) || (isMeRecipient && isTargetSender);
    });
  }, [messages, activeContact, currentIntern]);

  useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [activeChats]);

  // 3. Mark as Read automatically
  useEffect(() => {
    if (activeContact && activeChats.length > 0) {
      const key = `chat_${activeContact.id}`;
      setReadCounts(prev => {
        if (prev[key] === activeChats.length) return prev;
        const updated = { ...prev, [key]: activeChats.length };
        localStorage.setItem('eitp_chat_counts', JSON.stringify(updated));
        return updated;
      });
    }
  }, [activeChats, activeContact]);

  // 4. Red Dot Checker
  const hasUnread = (contactId) => {
    const dMsgs = messages.filter(m => {
       const isMeSender = String(m.sender_id) === String(currentIntern?.id);
       const isMeRecipient = String(m.recipient_id) === String(currentIntern?.id);
       if (contactId === 'all_admins') return (isMeSender && m.recipient_id === 'all_admins') || (isMeRecipient && m.type === 'direct_admin');
       return (isMeSender && String(m.recipient_id) === String(contactId)) || (isMeRecipient && String(m.sender_id) === String(contactId));
    });
    
    if (dMsgs.length === 0) return false;
    const lastMsg = dMsgs[dMsgs.length - 1];
    if (String(lastMsg.sender_id) === String(currentIntern?.id)) return false; // Hide dot if you replied
    
    return readCounts[`chat_${contactId}`] !== dMsgs.length;
  };

  const handleSend = async (e) => {
    e.preventDefault();
    if (!msgText.trim() && !msgFile) return;

    try {
      await sendUnifiedMessage({
        sender_id: currentIntern.id,
        sender_name: currentIntern.name,
        recipient_id: activeContact.id,
        recipient_name: activeContact.name,
        text: msgText,
        file: msgFile,
        type: activeContact.id === 'all_admins' ? 'direct_admin' : (mode === 'admin' ? 'direct_admin' : 'intern_to_intern')
      });
      setMsgText('');
      setMsgFile(null);
    } catch (err) { alert("Message failed to send."); }
  };

  return (
    <div className="flex h-[75vh] min-h-[600px] bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
      
      {/* LEFT SIDEBAR (CONTACTS) */}
      <div className="w-80 border-r bg-slate-50 flex flex-col shrink-0">
        <div className="p-4 bg-white border-b shadow-sm z-10 space-y-3">
          <h2 className="font-black text-xl text-slate-800">Messages</h2>
          <div className="relative">
            <Search className="absolute left-3 top-2.5 text-slate-400" size={16} />
            <input type="text" placeholder="Search contacts..." className="w-full pl-10 pr-4 py-2 bg-slate-100 rounded-xl text-xs outline-none focus:ring-2 focus:ring-blue-100" value={search} onChange={e => setSearch(e.target.value)} />
          </div>
        </div>
        <div className="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar">
          {contactsList.map(c => (
            <div key={c.id} onClick={() => setActiveContact(c)} className={`relative p-3 rounded-2xl cursor-pointer flex items-center gap-3 transition-all ${activeContact?.id === c.id ? 'bg-blue-600 text-white shadow-md' : 'hover:bg-white border border-transparent hover:border-slate-200'}`}>
              <div className={`w-12 h-12 rounded-full flex items-center justify-center shrink-0 ${activeContact?.id === c.id ? 'bg-white/20' : 'bg-slate-200 text-slate-600'}`}>
                 {c.isGroup ? <Users size={20}/> : <User size={20}/>}
              </div>
              <div className="overflow-hidden flex-1">
                <p className="font-bold text-sm truncate">{c.name}</p>
                {c.branch && <p className={`text-[10px] uppercase truncate ${activeContact?.id === c.id ? 'text-blue-200' : 'text-slate-400'}`}>{c.branch}</p>}
              </div>
              {/* RED DOT */}
              {hasUnread(c.id) && activeContact?.id !== c.id && (
                <div className="w-2.5 h-2.5 bg-red-500 rounded-full animate-pulse shadow-[0_0_5px_red] shrink-0" />
              )}
            </div>
          ))}
          {contactsList.length === 0 && <p className="text-center text-xs text-slate-400 mt-10">No contacts found.</p>}
        </div>
      </div>

      {/* RIGHT SIDEBAR (CHAT) */}
      <div className="flex-1 flex flex-col bg-[#e5ddd5] relative">
        {activeContact ? (
          <>
            {/* Header */}
            <div className="p-3 bg-[#f0f2f5] border-b flex items-center gap-3 shadow-sm z-10">
               <div className="w-10 h-10 rounded-full bg-white flex items-center justify-center border shadow-sm">
                 {activeContact.isGroup ? <Users size={20} className="text-blue-600"/> : <User size={20} className="text-blue-600"/>}
               </div>
               <div>
                  <div className="font-bold text-slate-800 text-sm">{activeContact.name}</div>
                  <div className="text-[10px] text-green-600 font-black uppercase tracking-widest animate-pulse">Online</div>
               </div>
            </div>
            
            {/* Messages */}
            <div className="flex-1 overflow-y-auto p-6 space-y-4 custom-scrollbar">
              {activeChats.map((msg, i) => {
                const isMe = String(msg.sender_id) === String(currentIntern?.id);
                return (
                  <div key={msg.id || i} className={`w-full flex flex-col ${isMe ? 'items-end' : 'items-start'}`}>
                    <div className={`p-3 rounded-2xl text-sm shadow-sm w-fit max-w-[75%] ${isMe ? 'bg-[#dcf8c6] text-slate-800 rounded-tr-none' : 'bg-white text-slate-800 rounded-tl-none'}`}>
                      {!isMe && <p className="text-[10px] font-black text-blue-600 mb-1 uppercase tracking-widest">{msg.sender_name}</p>}
                      {msg.file_url && (
                        <a href={msg.file_url} target="_blank" rel="noreferrer" className="flex items-center gap-2 p-2 bg-black/5 rounded-lg text-xs font-bold mb-2 border hover:bg-black/10 transition-all"><Paperclip size={12}/> {msg.file_name}</a>
                      )}
                      <p className="leading-relaxed whitespace-pre-wrap">{msg.text}</p>
                      <div className="flex justify-end items-center mt-1 opacity-50 text-[9px] font-bold gap-1">
                        <span>{msg.time}</span>
                        {isMe && <CheckCircle size={10} className="text-blue-500 ml-1"/>}
                        {isMe && <button onClick={() => deleteUnifiedMessage(msg.id)} className="hover:text-red-500 ml-1"><Trash2 size={10}/></button>}
                      </div>
                    </div>
                  </div>
                );
              })}
              <div ref={chatEndRef} />
            </div>

            {/* Input */}
            <div className="p-3 bg-[#f0f2f5] flex flex-col">
              {msgFile && (
                <div className="flex items-center gap-2 bg-white px-3 py-1.5 rounded-lg w-fit mb-2 shadow-sm border text-xs font-bold">
                  <Paperclip size={12} /> {msgFile.name}
                  <button onClick={() => setMsgFile(null)} className="hover:text-red-500 ml-2"><X size={12}/></button>
                </div>
              )}
              <form onSubmit={handleSend} className="flex items-center gap-3">
                <label className="p-2 text-slate-500 hover:text-blue-600 cursor-pointer transition-colors shrink-0">
                  <Paperclip size={22} /><input type="file" className="hidden" onChange={e => setMsgFile(e.target.files[0])} />
                </label>
                <input type="text" placeholder="Type a message..." className="flex-1 bg-white border-none px-4 py-3 rounded-xl outline-none text-sm shadow-sm focus:ring-2 focus:ring-blue-100 transition-all" value={msgText} onChange={e => setMsgText(e.target.value)} />
                <button type="submit" disabled={!msgText.trim() && !msgFile} className="p-3 bg-[#00a884] disabled:opacity-50 text-white rounded-full shadow-md transition-all shrink-0"><Send size={18}/></button>
              </form>
            </div>
          </>
        ) : (
          <div className="flex-1 flex flex-col items-center justify-center text-slate-500 bg-[#f8f9fa] p-10 text-center">
            <div className="w-24 h-24 bg-slate-200 rounded-full flex items-center justify-center mb-6 shadow-sm"><MessageCircle size={48} className="opacity-40" /></div>
            <h3 className="text-xl font-bold text-slate-700 mb-2">Secure Team Chat</h3>
            <p className="max-w-[300px] text-sm">Select a contact from the menu to view your chat history and share files.</p>
          </div>
        )}
      </div>
    </div>
  );
}
